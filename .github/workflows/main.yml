name: CI/CD for NestJS - Security Testing Only

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js (v22)
      uses: actions/setup-node@v3
      with:
        node-version: 22

    - name: Install dependencies
      run: npm install

    - name: Run static code analysis (ESLint) for security issues
      run: npm run lint  # optional, only if you have eslint configured

    - name: Run Snyk Dependency Scan for vulnerabilities
      uses: snyk/actions@v2  # Updated to snyk/actions@v2
      with:
        snyk-token: ${{ secrets.SNYK_TOKEN }}  # Set up your Snyk token in GitHub secrets
      run: snyk test  # Scans for vulnerabilities in dependencies

    - name: Check for vulnerabilities with Trivy (if you have a Dockerfile)
      run: |
        trivy fs --no-progress .  # Scans the file system for known vulnerabilities, optional if using Docker

    - name: Check for secret leaks using GitHub Secret Scanning (optional)
      uses: github/codeql-action/init@v2
      with:
        languages: 'javascript'
    - name: Run CodeQL analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: 'security'
